$PSDefaultParameterValues['*:Encoding'] = 'UTF-8'

$OutputEncoding = [System.Text.UTF8Encoding]::new()

$SCRIPT_DIR = Split-Path -Parent $MyInvocation.MyCommand.Definition

Set-Location $SCRIPT_DIR

$ATFRAMEWORK_CMAKE_TOOLSET_THIRD_PARTY_CROSSCOMPILING_HOST_TOOL_BUILD_DIR = "@ATFRAMEWORK_CMAKE_TOOLSET_THIRD_PARTY_CROSSCOMPILING_HOST_TOOL_BUILD_DIR@"

if (("@ATFRAMEWORK_CMAKE_TOOLSET_THIRD_PARTY_LOW_MEMORY_MODE@".ToLower() -eq "true") -or 
    ("@ATFRAMEWORK_CMAKE_TOOLSET_THIRD_PARTY_LOW_MEMORY_MODE@".ToLower() -eq "yes") -or 
    ("@ATFRAMEWORK_CMAKE_TOOLSET_THIRD_PARTY_LOW_MEMORY_MODE@".ToLower() -eq "1") -or 
    ("@ATFRAMEWORK_CMAKE_TOOLSET_THIRD_PARTY_LOW_MEMORY_MODE@".ToLower() -eq "on")) {
    $LOW_MEMORY_MODE = $true
}
else {
    $LOW_MEMORY_MODE = $false
}

Set-PSDebug -Trace 2

# build for host
$ENV:PATH = "$ATFRAMEWORK_CMAKE_TOOLSET_THIRD_PARTY_CROSSCOMPILING_HOST_TOOL_BUILD_DIR" + [IO.Path]::PathSeparator + "$ENV:PATH"

if (!(Test-Path "$ATFRAMEWORK_CMAKE_TOOLSET_THIRD_PARTY_CROSSCOMPILING_HOST_TOOL_BUILD_DIR" )) {
    New-Item -Path "$ATFRAMEWORK_CMAKE_TOOLSET_THIRD_PARTY_CROSSCOMPILING_HOST_TOOL_BUILD_DIR" -ItemType "directory" -Force
}

Set-Location "$ATFRAMEWORK_CMAKE_TOOLSET_THIRD_PARTY_CROSSCOMPILING_HOST_TOOL_BUILD_DIR"

if (Test-Path "CMakeCache.txt") {
    Remove-Item -Force "CMakeCache.txt"
}

. "@ATFRAMEWORK_CMAKE_TOOLSET_THIRD_PARTY_HOST_RESET_BUILD_ENVS_PWSH@"
& @ATFRAMEWORK_CMAKE_TOOLSET_THIRD_PARTY_CROSSCOMPILING_HOST_BUILD_FLAGS_PWSH@ "-DCMAKE_INSTALL_PREFIX=@PROJECT_THIRD_PARTY_HOST_INSTALL_DIR@"

if ($LOW_MEMORY_MODE) {
    & "@CMAKE_COMMAND@" --build . --config "@CMAKE_BUILD_TYPE@" "-j@ATFRAMEWORK_CMAKE_TOOLSET_THIRD_PARTY_LOW_MEMORY_JOBS@"
}
else {
    & "@CMAKE_COMMAND@" --build . --config "@CMAKE_BUILD_TYPE@" -j
}

if ( $LastExitCode -ne 0 ) {
    if ($LOW_MEMORY_MODE) {
        & "@CMAKE_COMMAND@" --build . --verbose --config "@CMAKE_BUILD_TYPE@" "-j@ATFRAMEWORK_CMAKE_TOOLSET_THIRD_PARTY_LOW_MEMORY_JOBS@"
    }
    else {
        & "@CMAKE_COMMAND@" --build . --verbose --config "@CMAKE_BUILD_TYPE@" -j
    }
    exit $LastExitCode
}

if ( $LastExitCode -ne 0 ) {
    exit $LastExitCode
}
. "@ATFRAMEWORK_CMAKE_TOOLSET_THIRD_PARTY_HOST_RESTORE_BUILD_ENVS_PWSH@"
